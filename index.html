<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL Shortener</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
      }
      div {
        margin: 1em;
      }
      h2 {
        margin-top: 2em;
      }
      .list-container {
        display: flex;
        justify-content: center;
      }
      ul {
        padding: 0;
        margin: 0;
        display: flex;
        max-width: 800px;
        gap: 0.5em 2em;
        flex-wrap: wrap;
        place-content: center;
      }
      li {
        display: inline;
      }
    </style>
  </head>

  <body>
    <h1>URL Shortener</h1>
    <section>
      <form class="shorten">
        <div>
          <label>URL <input type="url" name="url" /></label>
        </div>
        <button type="submit">Shorten</button>
        <div class="result-container" hidden>
          Short URL: <a class="result" href="#"></a>
        </div>
        <div class="result-container-error" hidden></div>
      </form>
    </section>

    <section>
      <h2>Edit URL</h2>
      <div>
        <form class="edit">
          <div>
            <label>
              <span class="origin"></span>
              <input name="id" placeholder="URL ID" />
            </label>
          </div>
          <div>
            <label>New URL <input type="url" name="new-url" /></label>
          </div>
          <button type="submit">Update URL</button>
          <div class="result-container" hidden>
            Success: <a class="result" href="#"></a>
          </div>
          <div class="result-container-error" hidden></div>
        </form>
      </div>
    </section>

    <section>
      <h2>Delete URL</h2>
      <div>
        <form class="delete">
          <div>
            <label>
              <span class="origin"></span>
              <input name="del-id" placeholder="URL ID" />
            </label>
          </div>
          <button type="submit">Delete URL</button>
          <button class="delete-all">Delete all URLs</button>
          <div class="result-container" hidden>Success</div>
          <div class="result-container-error" hidden></div>
        </form>
      </div>
    </section>

    <section>
      <h2>List URLs</h2>
      <button class="load-urls">Load URLs</button>
      <div class="list-container">
        <ul class="urls"></ul>
      </div>
    </section>

    <section>
      <h2 id="login">Login</h2>
      <form class="login">
        <div>
          <label> Username <input name="username" /> </label>
        </div>
        <div>
          <label> Password <input name="password" type="password" /> </label>
        </div>
        <button type="submit">Login</button>
        <button class="register">Register</button>
        <div class="result-container" hidden>Success</div>
        <div class="result-container-error" hidden></div>
      </form>

      <h3>Token</h3>
      <form class="token">
        <div>
          <label> Token <input name="token" /> </label>
        </div>
        <button type="submit">Verify</button>
        <div class="result-container" hidden>Success</div>
        <div class="result-container-error" hidden></div>
      </form>
    </section>

    <script>
      const SHORTENER_SERVICE = location.origin;
      let authUrl = new URL(location.href);
      authUrl.port = 8001;
      const AUTH_SERVICE = authUrl.origin;

      const $ = (query) => document.querySelector(query);
      const $$ = (query) => document.querySelectorAll(query);

      async function shortenUrl(url) {
        const response = await fetch(`${SHORTENER_SERVICE}/`, {
          method: "POST",
          body: JSON.stringify({
            value: url,
          }),
          headers: {
            Accept: "application/json",
            "Content-type": "application/json",
          },
        });
        if (response.status === 400) {
          throw new Error("URL is malformed");
        }
        const { id } = await response.json();
        return `${SHORTENER_SERVICE}/${id}`;
      }

      $(".shorten").addEventListener("submit", async (e) => {
        e.preventDefault();
        const url = $("[name=url]").value;
        const resultEl = $(".result");
        try {
          resultEl.innerText = resultEl.href = await shortenUrl(url);
          $(".shorten .result-container").hidden = false;
          $(".shorten .result-container-error").hidden = true;
        } catch (e) {
          $(".shorten .result-container-error").innerText = e;
          $(".shorten .result-container").hidden = true;
          $(".shorten .result-container-error").hidden = false;
        }
      });

      async function editUrl(urlId, url) {
        const response = await fetch(`${SHORTENER_SERVICE}/${urlId}`, {
          method: "PUT",
          body: JSON.stringify({ url }),
          headers: {
            Accept: "application/json",
            "Content-type": "application/json",
          },
        });
        if (response.status === 400) {
          throw new Error("URL is malformed");
        } else if (response.status === 404) {
          throw new Error("ID does not exist");
        }
        const { id } = await response.json();
        return `${SHORTENER_SERVICE}/${id}`;
      }

      $(".edit").addEventListener("submit", async (e) => {
        e.preventDefault();
        const url = $("[name=new-url]").value;
        const id = $("[name=id]").value;
        const resultEl = $(".edit .result");
        try {
          resultEl.innerText = resultEl.href = await editUrl(id, url);
          $(".edit .result-container").hidden = false;
          $(".edit .result-container-error").hidden = true;
        } catch (e) {
          $(".edit .result-container-error").innerText = e;
          $(".edit .result-container").hidden = true;
          $(".edit .result-container-error").hidden = false;
        }
      });

      async function deleteUrl(urlId) {
        const response = await fetch(`${SHORTENER_SERVICE}/${urlId}`, {
          method: "DELETE",
        });
        if (response.status === 404) {
          throw new Error("ID does not exist");
        }
      }

      $(".delete").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = $("[name=del-id]").value;
        try {
          await deleteUrl(id);
          $(".delete .result-container").hidden = false;
          $(".delete .result-container-error").hidden = true;
        } catch (e) {
          $(".delete .result-container-error").innerText = e;
          $(".delete .result-container").hidden = true;
          $(".delete .result-container-error").hidden = false;
        }
      });

      async function deleteAll() {
        const response = await fetch(`${SHORTENER_SERVICE}/`, {
          method: "DELETE",
        });
      }

      $(".delete-all").addEventListener("click", async (e) => {
        e.preventDefault();
        await deleteAll();
        $(".delete .result-container").hidden = false;
        $(".delete .result-container-error").hidden = true;
      });

      async function loadUrls() {
        const response = await fetch(`${SHORTENER_SERVICE}/`, {
          headers: {
            Accept: "application/json",
          },
        });
        const { value } = await response.json();
        if (value === null) {
          return [];
        } else {
          return value;
        }
      }

      $(".load-urls").addEventListener("click", async (e) => {
        const urls = await loadUrls();
        const urlsList = $(".urls");
        urlsList.innerHTML = "";
        for (const url of urls) {
          const a = document.createElement("a");
          a.innerText = a.href = `${SHORTENER_SERVICE}/${url}`;
          const li = document.createElement("li");
          li.appendChild(a);
          urlsList.appendChild(li);
        }
      });

      async function login(username, password) {
        const response = await fetch(`${AUTH_SERVICE}/users/login`, {
          method: "POST",
          body: JSON.stringify({ username, password }),
          headers: {
            Accept: "application/json",
          },
        });
        if (response.status === 403) {
          throw new Error("Incorrect credentials");
        }
        const { token } = await response.json();
        return token;
      }

      $(".login").addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = $("[name=username]").value;
        const password = $("[name=password]").value;
        try {
          const token = await login(username, password);
          $(".login .result-container").hidden = false;
          $(".login .result-container").innerText = "Successfully logged in";
          $(".login .result-container-error").hidden = true;
          $("[name=token]").value = token;
        } catch (e) {
          $(".login .result-container-error").innerText = e;
          $(".login .result-container").hidden = true;
          $(".login .result-container-error").hidden = false;
        }
      });

      async function register(username, password) {
        const response = await fetch(`${AUTH_SERVICE}/users`, {
          method: "POST",
          body: JSON.stringify({ username, password }),
          headers: {
            Accept: "application/json",
          },
        });
        if (response.status === 409) {
          throw new Error("Username already exists");
        }
      }

      $(".register").addEventListener("click", async (e) => {
        e.preventDefault();
        const username = $("[name=username]").value;
        const password = $("[name=password]").value;
        try {
          await register(username, password);
          $(".login .result-container").hidden = false;
          $(".login .result-container").innerText = "Successfully registered";
          $(".login .result-container-error").hidden = true;
        } catch (e) {
          $(".login .result-container-error").innerText = e;
          $(".login .result-container").hidden = true;
          $(".login .result-container-error").hidden = false;
        }
      });

      async function verify(token) {
        const response = await fetch(`${AUTH_SERVICE}/auth/verify`, {
          method: "POST",
          headers: {
            Accept: "application/json",
            Authorization: token,
          },
        });
        if (response.status === 403) {
          throw new Error("Token is invalid");
        }
        const { payload } = await response.json();
        return payload;
      }

      $(".token").addEventListener("submit", async (e) => {
        e.preventDefault();
        const token = $("[name=token]").value;
        try {
          const payload = await verify(token);
          $(".token .result-container").hidden = false;
          $(".token .result-container").innerText =
            `Welcome, ${JSON.stringify(payload)}`;
          $(".token .result-container-error").hidden = true;
          $("[name=token]").value = token;
        } catch (e) {
          $(".token .result-container-error").innerText = e;
          $(".token .result-container").hidden = true;
          $(".token .result-container-error").hidden = false;
        }
      });

      $$(".origin").forEach((x) => (x.innerText = `${SHORTENER_SERVICE}/`));
    </script>
  </body>
</html>
