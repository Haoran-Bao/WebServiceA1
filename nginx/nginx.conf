events { }

http {
    # Authentication service - Instances for load balancing
    upstream auth_service {
        server auth-service-1:8001;
        server auth-service-2:8001;
        server auth-service-3:8001;
    }

    # URL Shortener service - Instances for load balancing
    upstream url_shortener_service {
        server url-shortener-1:8000;
        server url-shortener-2:8000;
        server url-shortener-3:8000;
        server url-shortener-4:8000;
    }

    # Frontend service - Instances for load balancing
    upstream frontend_service {
        server frontend-1:8002;
        server frontend-2:8002;
    }

    server {
        listen 80;
        server_name localhost;

        # Path-based routing: Authentication service
        location /auth/ {
            rewrite ^/auth/(.*) /$1 break;
            proxy_pass http://auth_service;
            proxy_set_header Host $host;
        }

        # Path-based routing: URL shortener service
        location /shortener/ {
            rewrite ^/shortener/(.*) /$1 break;
            proxy_pass http://url_shortener_service;
            proxy_set_header Host $host;
        }

        # Path-based routing: frontend service
        location /frontend/ {
            rewrite ^/frontend/(.*) /$1 break;
            proxy_pass http://frontend_service;
            proxy_set_header Host $host;
        }

        # Default route
        location / {
            default_type application/json;
            return 200 '{"message":"Microservices API Gateway","services":{"auth":"/auth/","shortener":"/shortener/"},"endpoints":{"auth":{"create_user":"POST /auth/users","login":"POST /auth/users/login","verify":"POST /auth/auth/verify"},"shortener":{"create":"POST /shortener/","get":"GET /shortener/{id}","list":"GET /shortener/","update":"PUT /shortener/{id}","delete":"DELETE /shortener/{id}"}}}';
        }
    }
}
